#!/usr/bin/env python3
"""데이터 전처리 + 변수 생성 — 서울 아파트 매매가격 결정요인 분석"""
import os
import numpy as np
import pandas as pd
from math import radians, cos, sin, asin, sqrt

DATA_DIR = os.path.join(os.path.dirname(__file__), 'data')

# 서울 25개 구 법정동 매핑 (주요 법정동 → 구)
GU_MAPPING = {
    '종로구': ['사직동','삼청동','부암동','평창동','무악동','교남동','가회동','종로1가','종로2가','종로3가','종로4가','종로5가','종로6가',
               '이화동','연건동','충신동','동숭동','혜화동','명륜1가','명륜2가','명륜3가','명륜4가','창신동','숭인동','교북동','행촌동',
               '구기동','청운동','신영동','궁정동','효자동','창성동','통의동','적선동','통인동','누상동','누하동','옥인동','필운동',
               '내수동','사간동','송현동','안국동','소격동','화동','계동','원서동','팔판동','삼청동','재동','체부동','청진동','수송동',
               '중학동','종로1·2·3·4가동','종로5·6가동','이화동','혜화동','창신1동','창신2동','창신3동','숭인1동','숭인2동',
               '세종로','내자동','적선동','견지동','와룡동','권농동','묘동','봉익동','돈의동','장사동','관철동','관수동','인사동',
               '경운동','익선동','낙원동','서린동','청운효자동','사직동','삼청동','부암동','평창동','무악동','교남동'],
    '중구': ['소공동','회현동','명동','필동','장충동','광희동','을지로동','신당동','다산동','약수동','청구동','황학동','중림동',
             '회현동1가','회현동2가','명동1가','명동2가','충무로1가','충무로2가','충무로3가','충무로4가','충무로5가',
             '을지로1가','을지로2가','을지로3가','을지로4가','을지로5가','을지로6가','을지로7가',
             '남대문로1가','남대문로2가','남대문로3가','남대문로4가','남대문로5가',
             '장충동1가','장충동2가','필동1가','필동2가','필동3가','쌍림동','예관동','묵정동','신당1동','신당2동','신당3동','신당4동','신당5동','신당6동',
             '주자동','수하동','수표동','입정동','저동1가','저동2가','초동','산림동','무교동','다동','서소문동','정동','순화동',
             '의주로1가','의주로2가','만리동1가','만리동2가','봉래동1가','봉래동2가','남창동','북창동','양동',
             '광희동1가','광희동2가','오장동','예장동','방산동','도원동','예관동','흥인동'],
    '용산구': ['후암동','남영동','용산동','이태원동','한남동','서빙고동','보광동','용문동','원효로','이촌동','청파동',
               '용산동1가','용산동2가','용산동3가','용산동4가','용산동5가','용산동6가','갈월동','동자동','서계동',
               '청파동1가','청파동2가','청파동3가','원효로1가','원효로2가','원효로3가','원효로4가','신창동','산천동',
               '문배동','신계동','한강로1가','한강로2가','한강로3가','이촌동','이태원동','한남동','동빙고동','서빙고동',
               '주성동','용산2가','효창동','도원동','청암동','보광동','녹사평대로'],
    '성동구': ['왕십리','마장동','사근동','행당동','응봉동','금호동','옥수동','성수동','송정동','용답동','하왕십리동','상왕십리동',
               '홍익동','도선동','성수1가','성수2가','성수동1가','성수동2가','금호동1가','금호동2가','금호동3가','금호동4가'],
    '광진구': ['중곡동','능동','구의동','광장동','자양동','화양동','군자동','구의1동','구의2동','구의3동','자양1동','자양2동','자양3동','자양4동'],
    '동대문구': ['신설동','용두동','제기동','전농동','답십리동','장안동','청량리동','회기동','휘경동','이문동',
                '전농1동','전농2동','답십리1동','답십리2동','장안1동','장안2동'],
    '중랑구': ['면목동','상봉동','중화동','묵동','망우동','신내동','면목2동','면목3동','면목4동','면목5동','면목7동','면목본동',
               '상봉1동','상봉2동','중화1동','중화2동','묵1동','묵2동','망우1동','망우2동','망우3동','신내1동','신내2동'],
    '성북구': ['성북동','삼선동','동선동','돈암동','안암동','보문동','정릉동','길음동','종암동','하월곡동','상월곡동','장위동','석관동',
               '삼선동1가','삼선동2가','삼선동3가','삼선동4가','삼선동5가','보문동1가','보문동2가','보문동3가',
               '보문동4가','보문동5가','보문동6가','보문동7가','안암동1가','안암동2가','안암동3가','안암동4가','안암동5가',
               '성북동1가','동소문동1가','동소문동2가','동소문동3가','동소문동4가','동소문동5가','동소문동6가','동소문동7가'],
    '강북구': ['미아동','번동','수유동','우이동','삼양동','송중동','송천동','삼각산동','인수동'],
    '도봉구': ['쌍문동','방학동','창동','도봉동','쌍문1동','쌍문2동','쌍문3동','쌍문4동','방학1동','방학2동','방학3동','창1동','창2동','창3동','창4동','창5동','도봉1동','도봉2동'],
    '노원구': ['월계동','공릉동','하계동','상계동','중계동','상계1동','상계2동','상계3동','상계4동','상계5동','상계6동','상계7동','상계8동','상계9동','상계10동',
               '중계1동','중계2동','중계3동','중계4동','중계본동','하계1동','하계2동'],
    '은평구': ['녹번동','불광동','갈현동','구산동','대조동','응암동','역촌동','신사동','증산동','수색동','진관동','진관외동','진관내동',
               '응암1동','응암2동','응암3동'],
    '서대문구': ['충정로','합동','미근동','냉천동','천연동','옥천동','영천동','현저동','북아현동','홍제동','대현동','대신동','신촌동','봉원동','창천동','연희동','홍은동','남가좌동','북가좌동'],
    '마포구': ['아현동','공덕동','신공덕동','도화동','용강동','토정동','마포동','합정동','망원동','연남동','성산동','상암동','중동','서강동','서교동','동교동','염리동','노고산동','대흥동',
              '신수동','현석동','구수동','창전동','상수동','하중동','신정동','당인동'],
    '양천구': ['목동','신월동','신정동','목1동','목2동','목3동','목4동','목5동','신월1동','신월2동','신월3동','신월4동','신월5동','신월6동','신월7동',
               '신정1동','신정2동','신정3동','신정4동','신정6동','신정7동'],
    '강서구': ['염창동','등촌동','화곡동','가양동','마곡동','내발산동','외발산동','공항동','방화동','개화동','과해동','오곡동','오쇠동',
               '화곡1동','화곡2동','화곡3동','화곡4동','화곡6동','화곡8동','가양1동','가양2동','가양3동','방화1동','방화2동','방화3동'],
    '구로구': ['신도림동','구로동','가리봉동','고척동','개봉동','오류동','궁동','온수동','천왕동','항동',
               '구로1동','구로2동','구로3동','구로4동','구로5동','가리봉동','고척1동','고척2동','개봉1동','개봉2동','개봉3동','오류1동','오류2동','수궁동'],
    '금천구': ['가산동','독산동','시흥동','독산1동','독산2동','독산3동','독산4동','시흥1동','시흥2동','시흥3동','시흥4동','시흥5동'],
    '영등포구': ['영등포동','당산동','여의도동','신길동','대림동','도림동','문래동','양평동','신길1동','신길3동','신길4동','신길5동','신길6동','신길7동',
                '당산1동','당산2동','영등포동','영등포본동','여의동','대림1동','대림2동','대림3동',
                '당산동1가','당산동2가','당산동3가','당산동4가','당산동5가','당산동6가',
                '영등포동1가','영등포동2가','영등포동3가','영등포동4가','영등포동5가','영등포동6가','영등포동7가','영등포동8가',
                '문래동1가','문래동2가','문래동3가','문래동4가','문래동5가','문래동6가',
                '양평동1가','양평동2가','양평동3가','양평동4가','양평동5가','양평동6가',
                '양화동','양화동1가'],
    '동작구': ['노량진동','상도동','흑석동','동작동','사당동','대방동','신대방동','본동',
               '상도1동','상도2동','상도3동','상도4동','사당1동','사당2동','사당3동','사당4동','사당5동',
               '신대방1동','신대방2동','대방동','노량진1동','노량진2동'],
    '관악구': ['봉천동','신림동','남현동','은천동','성현동','청룡동','행운동','낙성대동','인헌동','미성동','난곡동','조원동','대학동','삼성동','서원동','서림동','신사동','신원동','중앙동'],
    '서초구': ['서초동','잠원동','반포동','방배동','양재동','내곡동','염곡동','우면동','원지동','신원동'],
    '강남구': ['역삼동','개포동','청담동','삼성동','대치동','신사동','논현동','압구정동','세곡동','자곡동','율현동','일원동','수서동','도곡동'],
    '송파구': ['잠실동','신천동','풍납동','송파동','거여동','마천동','방이동','오금동','가락동','문정동','장지동','위례동','삼전동','석촌동',
               '잠실본동','풍납1동','풍납2동','거여1동','거여2동','오금동','송파1동','송파2동'],
    '강동구': ['강일동','상일동','명일동','고덕동','암사동','천호동','성내동','길동','둔촌동',
               '강일동','상일1동','상일2동','명일동','고덕1동','고덕2동','암사1동','암사2동','암사3동',
               '천호1동','천호2동','천호3동','성내1동','성내2동','성내3동'],
}

# 법정동 → 구 역매핑
DONG_TO_GU = {}
for gu, dongs in GU_MAPPING.items():
    for dong in dongs:
        DONG_TO_GU[dong] = gu

# 추가 매핑 (미매핑 법정동)
DONG_TO_GU.update({
    '홍파동': '중구', '충정로3가': '서대문구', '평동': '중구', '연지동': '종로구',
    '효제동': '종로구', '인의동': '종로구', '인현동2가': '중구', 
    '동선동1가': '성북구', '충정로2가': '서대문구', '동선동4가': '성북구',
    '동선동2가': '성북구', '동선동3가': '성북구', '동선동5가': '성북구',
    '인현동1가': '중구', '무학동': '종로구', '이화동': '종로구',
    '충정로1가': '서대문구', '예장동': '중구',
})

# 강남권 구 (강남3구 + 서초 + 용산 + 마포 + 성동)
GANGNAM_GU = {'강남구', '서초구', '송파구'}

def haversine(lon1, lat1, lon2, lat2):
    """두 지점 간 거리 (km)"""
    lon1, lat1, lon2, lat2 = map(radians, [lon1, lat1, lon2, lat2])
    dlon = lon2 - lon1
    dlat = lat2 - lat1
    a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
    return 2 * 6371 * asin(sqrt(a))

def min_distance(lat, lon, ref_df, lat_col='위도', lon_col='경도'):
    """가장 가까운 시설까지의 거리 (km)"""
    if pd.isna(lat) or pd.isna(lon) or ref_df.empty:
        return np.nan
    dists = ref_df.apply(lambda r: haversine(lon, lat, r[lon_col], r[lat_col]), axis=1)
    return dists.min()

def count_within(lat, lon, ref_df, radius_km, lat_col='위도', lon_col='경도'):
    """반경 내 시설 수"""
    if pd.isna(lat) or pd.isna(lon) or ref_df.empty:
        return 0
    dists = ref_df.apply(lambda r: haversine(lon, lat, r[lon_col], r[lat_col]), axis=1)
    return (dists <= radius_km).sum()

def tm_to_wgs84(x, y):
    """중부원점TM (EPSG:5174) → WGS84 (간이 변환)"""
    # 간이 변환 — pyproj 없이 근사 변환
    # 서울 중심부 기준 (더 정확하려면 pyproj 사용)
    lat = 37.0 + (y - 185000) / 111000
    lon = 127.0 + (x - 200000) / (111000 * cos(radians(37.5)))
    return lat, lon

def main():
    print("=" * 60)
    print("데이터 전처리 시작")
    print("=" * 60)
    
    # 1. 실거래가 로드
    print("\n[1/7] 아파트 실거래가 로드...")
    apt = pd.read_csv(os.path.join(DATA_DIR, 'apartment_trades.csv'))
    apt['거래금액'] = pd.to_numeric(apt['거래금액'].astype(str).str.replace(',', ''), errors='coerce')
    apt['전용면적'] = pd.to_numeric(apt['전용면적'], errors='coerce')
    apt['층'] = pd.to_numeric(apt['층'], errors='coerce')
    apt['건축년도'] = pd.to_numeric(apt['건축년도'], errors='coerce')
    apt['거래년월'] = apt['거래년월'].astype(str).str.strip()
    
    # 거래년도 추출
    apt['거래년도'] = apt['거래년월'].str[:4].astype(int)
    
    # 건물연령 계산
    apt['건물연령'] = apt['거래년도'] - apt['건축년도']
    
    # 법정동 → 구 매핑
    print("[2/7] 법정동 → 구 매핑...")
    apt['구'] = apt['법정동'].map(DONG_TO_GU)
    unmapped = apt['구'].isna().sum()
    if unmapped > 0:
        print(f"  ⚠️ 매핑 안 된 법정동: {unmapped}건")
        # 미매핑 법정동 출력 (상위 10개)
        unmapped_dongs = apt[apt['구'].isna()]['법정동'].value_counts().head(10)
        print(f"  Top unmapped: {dict(unmapped_dongs)}")
    
    # 강남/비강남 구분
    apt['강남구분'] = apt['구'].apply(lambda x: 1 if x in GANGNAM_GU else 0)
    
    # 평당가격 (3.3058m² = 1평)
    apt['평당가격'] = apt['거래금액'] / (apt['전용면적'] / 3.3058)
    
    print(f"  총 {len(apt):,}건, 구 매핑 완료")
    
    # 2. 지하철역 거리 (구 단위 평균)
    print("\n[3/7] 지하철역 데이터 준비...")
    subway = pd.read_csv(os.path.join(DATA_DIR, 'seoul_subway_stations.csv'))
    # 컬럼명 확인
    print(f"  지하철 컬럼: {list(subway.columns)[:10]}")
    
    # 3. 공원 데이터
    print("\n[4/7] 공원 데이터 준비...")
    parks = pd.read_csv(os.path.join(DATA_DIR, 'seoul_parks.csv'))
    print(f"  공원 컬럼: {list(parks.columns)[:10]}")
    
    # 4. 학교 데이터
    print("\n[5/7] 학교 데이터 준비...")
    schools = pd.read_csv(os.path.join(DATA_DIR, 'seoul_schools.csv'))
    print(f"  학교 컬럼: {list(schools.columns)[:10]}")
    
    # 5. 거시경제 변수 병합
    print("\n[6/7] 거시경제 변수 병합...")
    macro = pd.read_csv(os.path.join(DATA_DIR, 'ecos_macro.csv'))
    macro['년월'] = macro['년월'].astype(str)
    apt = apt.merge(macro, left_on='거래년월', right_on='년월', how='left')
    apt.drop(columns=['년월'], inplace=True, errors='ignore')
    
    # 숫자 변환
    for col in ['기준금리', 'CD금리', '소비자물가지수', 'M2']:
        if col in apt.columns:
            apt[col] = pd.to_numeric(apt[col], errors='coerce')
    
    matched = apt['기준금리'].notna().sum()
    print(f"  거시경제 변수 매칭: {matched:,} / {len(apt):,}건")
    
    # 6. 구 단위 집계 변수 생성
    print("\n[7/7] 구 단위 집계 변수 생성...")
    
    # 구별 학교 수
    if 'SCHUL_NM' in schools.columns:
        schools_gu = schools.groupby(schools.columns[schools.columns.str.contains('GU|구|ADDR', case=False)].tolist()[0] if len(schools.columns[schools.columns.str.contains('GU|구|ADDR', case=False)]) > 0 else schools.columns[0]).size()
    
    # 7. 결측치 처리 & 이상치 제거
    print("\n결측치 현황:")
    print(apt.isnull().sum()[apt.isnull().sum() > 0])
    
    # 이상치 제거: 거래금액 0 이하, 전용면적 10 미만
    before = len(apt)
    apt = apt[(apt['거래금액'] > 0) & (apt['전용면적'] >= 10)]
    print(f"\n이상치 제거: {before:,} → {len(apt):,} ({before - len(apt):,}건 제거)")
    
    # 최종 저장
    out_path = os.path.join(DATA_DIR, 'apartment_final.csv')
    apt.to_csv(out_path, index=False, encoding='utf-8-sig')
    print(f"\n{'=' * 60}")
    print(f"최종 데이터: {len(apt):,}건 → {out_path}")
    print(f"컬럼: {list(apt.columns)}")
    print(f"{'=' * 60}")
    
    # 기초통계
    print("\n📊 기초통계:")
    print(apt[['거래금액', '전용면적', '층', '건물연령', '평당가격']].describe().round(2))
    
    print("\n📊 구별 평균 거래금액 (만원):")
    gu_mean = apt.groupby('구')['거래금액'].mean().sort_values(ascending=False)
    print(gu_mean.round(0).head(10))

if __name__ == '__main__':
    main()
